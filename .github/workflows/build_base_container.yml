---
name: build-base

env:
  REVISION: "0.1"
  BUILDX_NO_DEFAULT_ATTESTATIONS: 1

on:
  push:
    branches:
      - master

jobs:
  build_base_image:
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    strategy:
      matrix:
        container: [base, dev ]
        include:
          - container: base
            platform: linux/arm64/v8,linux/amd64
          - container: dev
            platform: linux/arm64/v8,linux/amd64

    steps:

      - name: Starting container build
        run: echo "Starting container build. Be patient. 🐢"

      - name: Checkout code ✅
        uses: actions/checkout@v3

      - name: Check if avd-base needs to be built 🤔
        uses: dorny/paths-filter@v2
        id: filter-avd-${{ matrix.container }}
        with:
          filters: |
            workflows:
              - 'avd-containers/${{ matrix.container }}/.devcontainer/**'
              - '.github/workflows/**'

      - name: setup QEMU for multi-arch builds 🏗️
        if: steps.filter-avd-${{ matrix.container }}.outputs.workflows == 'true'
        uses: docker/setup-qemu-action@v2
        with:
          platforms: ${{ matrix.platform }}

      - name: setup Docker buildX for multi-arch builds 🏗️
        if: steps.filter-avd-${{ matrix.container }}.outputs.workflows == 'true'
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub 🗝️
        if: steps.filter-avd-${{ matrix.container }}.outputs.workflows == 'true'
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pre-build dev container image 🔨
        if: steps.filter-avd-${{ matrix.container }}.outputs.workflows == 'true'
        uses: devcontainers/ci@v0.3
        with:
          subFolder: avd-containers/${{ matrix.container }}
          imageName: ghcr.io/ankudinov/avd-devcontainer/${{ matrix.container }}
          imageTag: latest,rev${{ env.REVISION }}
          platform: linux/arm64,linux/amd64
          push: always
