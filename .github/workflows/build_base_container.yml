---
name: build-all-containers

env:
  BUILDX_NO_DEFAULT_ATTESTATIONS: 1

on:
  push:
    branches:
      - master

jobs:

  build_base_container:
    # base container is not supposed to be used directly
    # it only contains essential tools and custom entrypoint
    # and is used as base for all other containers

    uses: ./.github/workflows/container_build_template.yml

    strategy:
      matrix:
        container: [base]
        platform: [ linux/arm64/v8, linux/amd64 ]
        include:
          - container: base
            tags: latest,rev0.1

    with:
      container_name: ${{ matrix.container }}
      container_tags: ${{ matrix.tags }}
      platform: ${{ matrix.platform }}

  build_all_containers:

    needs: [build_base_container]

    strategy:
      matrix:
        container: [ci, dev]
        platform: [ linux/arm64/v8, linux/amd64 ]
        include:
          - container: ci
            tags: latest,rev0.1
          - container: dev
            tags: latest,rev0.1

    uses: ./.github/workflows/container_build_template.yml

    with:
      container_name: ${{ matrix.container }}
      container_tags: ${{ matrix.tags }}
      platform: ${{ matrix.platform }}

  build_universal_container:

    needs: [build_all_containers]

    uses: ./.github/workflows/container_build_template.yml

    strategy:
      matrix:
        container: [universal]
        platform: [ linux/arm64/v8, linux/amd64 ]
        include:
          - container: universal
            tags: latest,rev0.1

    with:
      container_name: ${{ matrix.container }}
      container_tags: ${{ matrix.tags }}
      platform: ${{ matrix.platform }}
